<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Voice & Text Input App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
        100% {
          transform: scale(1);
        }
      }
      .pulse {
        animation: pulse 1.5s infinite;
      }
    </style>
  </head>
  <body class="bg-gradient-to-br from-blue-50 to-blue-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-md">
      <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
        <!-- Header -->
        <div class="bg-blue-500 text-white p-6">
          <h1 class="text-2xl font-bold text-center">
            Springroll Voice & Text Input
          </h1>
          <p class="text-center text-blue-100 mt-1">
            Speak or type your message
          </p>
        </div>

        <!-- Main Content -->
        <div class="p-6">
          <!-- Input Tabs -->
          <div class="flex mb-6 bg-gray-100 rounded-full p-1">
            <button
              id="textTab"
              class="flex-1 py-2 px-4 rounded-full font-medium transition-all duration-300 bg-white shadow-sm text-blue-600"
            >
              <i class="fas fa-keyboard mr-2"></i>Text
            </button>
            <button
              id="voiceTab"
              class="flex-1 py-2 px-4 rounded-full font-medium transition-all duration-300 text-gray-600"
            >
              <i class="fas fa-microphone mr-2"></i>Voice
            </button>
          </div>

          <!-- Text Input -->
          <div id="textInputSection" class="mb-6">
            <label
              for="textInput"
              class="block text-sm font-medium text-gray-700 mb-2"
              >Type your message:</label
            >
            <textarea
              id="textInput"
              rows="4"
              class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300"
              placeholder="Start typing here..."
            ></textarea>
            <div class="flex gap-2 mt-4">
              <button
                id="submitText"
                class="flex-1 bg-blue-500 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-all duration-300 flex items-center justify-center"
              >
                <i class="fas fa-paper-plane mr-2"></i> Submit
              </button>
            </div>
          </div>

          <!-- Voice Input -->
          <div id="voiceInputSection" class="mb-6 hidden">
            <div class="text-center">
              <button
                id="startRecording"
                class="mx-auto bg-blue-100 hover:bg-blue-200 text-blue-700 font-bold w-20 h-20 rounded-full flex items-center justify-center transition-all duration-300 mb-4"
              >
                <i class="fas fa-microphone text-2xl"></i>
              </button>
              <p id="recordingStatus" class="text-sm text-gray-600 mb-4">
                Press the microphone to start recording
              </p>
              <div class="relative">
                <div
                  id="voiceProcessing"
                  class="inset-0 bg-white bg-opacity-80 flex items-center justify-center hidden p-4"
                >
                  <div class="flex items-center">
                    <div
                      class="w-2 h-2 bg-blue-500 rounded-full mr-1 animate-bounce"
                    ></div>
                    <div
                      class="w-2 h-2 bg-blue-500 rounded-full mr-1 animate-bounce"
                      style="animation-delay: 0.2s"
                    ></div>
                    <div
                      class="w-2 h-2 bg-blue-500 rounded-full animate-bounce"
                      style="animation-delay: 0.4s"
                    ></div>
                  </div>
                </div>
                <textarea
                  id="voiceResult"
                  rows="4"
                  class="w-full px-4 py-3 rounded-lg border border-gray-300 bg-gray-50"
                  placeholder="Your speech will appear here..."
                  readonly
                ></textarea>
              </div>
              <div class="flex gap-2 mt-4">
                <button
                  id="submitVoice"
                  class="flex-1 bg-blue-500 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-all duration-300 flex items-center justify-center"
                >
                  <i class="fas fa-paper-plane mr-2"></i> Submit
                </button>
              </div>
            </div>
          </div>

          <!-- Output -->
          <div id="outputSection" class="mt-8">
            <h3 class="text-lg font-medium text-gray-900 mb-2">Your Input:</h3>
            <div
              id="outputContent"
              class="bg-gray-50 p-4 rounded-lg border border-gray-200"
            ></div>
            <p
              id="serverResponse"
              class="hidden text-sm text-gray-600 mt-2"
            ></p>
          </div>

          <!-- server response -->
          <div id="responseOutputSection" class="mt-8">
            <h3 class="text-lg font-medium text-gray-900 mb-2">
              Server Response:
            </h3>
            <div
              id="responseOutputContent"
              class="bg-gray-50 p-4 rounded-lg border border-gray-200"
            ></div>
            <!-- <p id="serverResponse" class="text-sm text-gray-600 mt-2"></p> -->
          </div>
          <div class="flex gap-2 mt-4">
            <button
              id="speakVoice"
              class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg transition-all duration-300 flex items-center justify-center"
            >
              <i class="fas fa-volume-up mr-2"></i> Speak
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const textTab = document.getElementById("textTab");
        const voiceTab = document.getElementById("voiceTab");
        const textInputSection = document.getElementById("textInputSection");
        const voiceInputSection = document.getElementById("voiceInputSection");
        const startRecording = document.getElementById("startRecording");
        const recordingStatus = document.getElementById("recordingStatus");
        const voiceResult = document.getElementById("voiceResult");
        const voiceProcessing = document.getElementById("voiceProcessing");
        const submitText = document.getElementById("submitText");
        const submitVoice = document.getElementById("submitVoice");
        const textInput = document.getElementById("textInput");
        const outputSection = document.getElementById("outputSection");
        const outputContent = document.getElementById("outputContent");
        const responseOutputSection = document.getElementById(
          "responseOutputSection"
        );
        const responseOutputContent = document.getElementById(
          "responseOutputContent"
        );
        const speakVoice = document.getElementById("speakVoice");
        const serverResponse = document.getElementById("serverResponse");

        // let responseSpeech =;
        // const responseSpeech = document.getElementById("responseOutputContent");

        // Tab switching
        textTab.addEventListener("click", () => {
          textTab.classList.add("bg-white", "shadow-sm", "text-blue-600");
          textTab.classList.remove("text-gray-600");
          voiceTab.classList.add("text-gray-600");
          voiceTab.classList.remove("bg-white", "shadow-sm", "text-blue-600");
          textInputSection.classList.remove("hidden");
          voiceInputSection.classList.add("hidden");
        });

        voiceTab.addEventListener("click", () => {
          if (voiceTab.disabled) return;
          voiceTab.classList.add("bg-white", "shadow-sm", "text-blue-600");
          voiceTab.classList.remove("text-gray-600");
          textTab.classList.add("text-gray-600");
          textTab.classList.remove("bg-white", "shadow-sm", "text-blue-600");
          voiceInputSection.classList.remove("hidden");
          textInputSection.classList.add("hidden");
          checkMicrophonePermission();
        });

        // ---- Microphone Permission Check ----
        async function checkMicrophonePermission() {
          try {
            const permissionStatus = await navigator.permissions.query({
              name: "microphone",
            });
            if (permissionStatus.state === "denied") {
              recordingStatus.textContent =
                "Microphone access denied. Please allow microphone access in your browser settings.";
              startRecording.disabled = true;
              startRecording.classList.add("opacity-50", "cursor-not-allowed");
            } else if (permissionStatus.state === "prompt") {
              recordingStatus.textContent =
                "Please grant microphone access when prompted.";
            } else {
              recordingStatus.textContent =
                "Press the microphone to start recording";
              startRecording.disabled = false;
              startRecording.classList.remove(
                "opacity-50",
                "cursor-not-allowed"
              );
            }
            permissionStatus.onchange = () => {
              if (permissionStatus.state === "granted") {
                recordingStatus.textContent =
                  "Press the microphone to start recording";
                startRecording.disabled = false;
                startRecording.classList.remove(
                  "opacity-50",
                  "cursor-not-allowed"
                );
              } else if (permissionStatus.state === "denied") {
                recordingStatus.textContent =
                  "Microphone access denied. Please allow microphone access in your browser settings.";
                startRecording.disabled = true;
                startRecording.classList.add(
                  "opacity-50",
                  "cursor-not-allowed"
                );
              }
            };
          } catch (err) {
            console.error("Permission check error:", err);
            recordingStatus.textContent =
              "Error checking microphone permissions.";
          }
        }

        // ---- Speech Recognition ----
        const SpeechRecognition =
          window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        let isRecording = false;

        if (SpeechRecognition) {
          recognition = new SpeechRecognition();
          recognition.continuous = true; // dictation mode
          recognition.interimResults = true; // show partial results
          recognition.lang = "en-US";

          let finalTranscript = "";

          recognition.onstart = function () {
            isRecording = true;
            startRecording.classList.add("pulse", "bg-red-500", "text-white");
            startRecording.classList.remove("bg-blue-100", "text-blue-700");
            recordingStatus.textContent = "Please speak now ...";
            voiceProcessing.classList.remove("hidden");
            finalTranscript = ""; // reset for new session
            voiceResult.value = "";
          };

          recognition.onresult = function (event) {
            let interimTranscript = "";
            for (let i = event.resultIndex; i < event.results.length; i++) {
              const transcript = event.results[i][0].transcript;
              if (event.results[i].isFinal) {
                finalTranscript += transcript + " ";
              } else {
                interimTranscript += transcript;
              }
            }
            // Display final + interim
            voiceResult.value = finalTranscript + interimTranscript;
          };

          recognition.onerror = function (event) {
            console.error("Speech recognition error:", event.error);
            recordingStatus.textContent = "Error: " + event.error;
            resetRecordingUI();
          };

          recognition.onend = function () {
            // only reset if user clicked stop, not on accidental disconnect
            if (!isRecording) resetRecordingUI();
          };
        } else {
          // Fallback for unsupported browsers
          voiceTab.disabled = true;
          voiceTab.innerHTML =
            '<i class="fas fa-microphone-slash mr-2"></i>Voice (Not Supported)';
          voiceTab.classList.add("opacity-50", "cursor-not-allowed");
          recordingStatus.textContent =
            "Speech recognition not supported in this browser";
        }

        function resetRecordingUI() {
          isRecording = false;
          startRecording.classList.remove("pulse", "bg-red-500", "text-white");
          startRecording.classList.add("bg-blue-100", "text-blue-700");
          voiceProcessing.classList.add("hidden");
          recordingStatus.textContent = "Recording stopped";
        }

        // ---- Start / Stop toggle ----
        startRecording.addEventListener("click", function () {
          if (!recognition) return;

          if (isRecording) {
            isRecording = false;
            recognition.stop();
          } else {
            try {
              recognition.start();
            } catch (err) {
              console.error("Recognition start error:", err);
              recordingStatus.textContent = "Error starting microphone";
            }
          }
        });

        // ---- Server Submission ----
        async function sendToServer(data, type) {
          // production
          try {
            const response = await fetch(
              "https://tdech-ai-voice-agent.onrender.com/webhook/get_data",
              // "https://tdech-ai-voice-agent.onrender.com/webhook-test/get_data",
              {
                method: "POST",
                headers: {
                  user: "springroll2977",
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ text: data, inputType: type }),
              }
            );
            if (!response.ok) {
              throw new Error(`Server error: ${response.status}`);
            }

            const result = await response.json();
            console.log("Server response:", result);
            serverResponse.textContent = `Server response: ${
              result.message || "Data received successfully"
            }`;
            serverResponse.classList.remove("text-red-600");
            serverResponse.classList.add("text-green-600");

            // responseSpeech = result.message;
            console.log("response = ", result.message);
            responseOutputContent.textContent = result.message;
            responseOutputSection.classList.remove("hidden");
            return result;
          } catch (error) {
            console.error("Error sending data to server:", error);
            console.log("data =", data, "type =", type);
            serverResponse.textContent = `${error.message}`;
            serverResponse.classList.remove("text-green-600");
            serverResponse.classList.add("text-red-600");

            // responseSpeech = error;
            responseOutputContent.textContent = error;
            responseOutputSection.classList.remove("hidden");
          }
        }

        // ---- Output display ----
        function showOutput(text, type) {
          outputContent.textContent = text;
          outputSection.classList.remove("hidden");

          setTimeout(
            () => outputSection.scrollIntoView({ behavior: "smooth" }),
            100
          );
          sendToServer(text, type);
        }

        submitText.addEventListener("click", function () {
          if (textInput.value.trim()) {
            showOutput(textInput.value, "text");
            textInput.value = ""; // Clear input after submission
          } else {
            showOutput("No text");
          }
        });

        submitVoice.addEventListener("click", function () {
          if (voiceResult.value.trim()) {
            showOutput(voiceResult.value, "voice");
            voiceResult.value = ""; // Clear input after submission
          } else {
            showOutput("No voice");
          }
        });

        // Enter key submit for text
        textInput.addEventListener("keydown", function (e) {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            submitText.click();
          }
        });

        // ---- Text-to-Speech (TTS) ----
        function speak(text) {
          if (!text.trim()) return;
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = "en-US";
          speechSynthesis.speak(utterance);
          console.log("Speaking text:", text);
        }

        speakVoice.addEventListener("click", function () {
          // speak(voiceResult.value || outputContent.textContent);
          speak(responseOutputContent.textContent);
        });

        // Initialize microphone permission check on page load
        if (SpeechRecognition) {
          checkMicrophonePermission();
        }
      });
    </script>
  </body>
</html>
